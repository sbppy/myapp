"use strict";angular.module("betaApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch"]).constant("paths",{"/":{redirectTo:"/login"},"/login":{templateUrl:"views/login.html",controller:"LoginCtrl"},"/about":{templateUrl:"views/about.html",controller:"AboutCtrl"},"/watched":{templateUrl:"views/watched.html",controller:"WatchedCtrl"},"/rank":{templateUrl:"views/rank.html",controller:"RankCtrl"},"/search/:name?":{templateUrl:"views/search.html",controller:"SearchCtrl"},"/product/:pid":{templateUrl:"views/product.html",controller:"ProductCtrl"},"/news/:skip?/:limit?":{templateUrl:"views/news.html",controller:"NewsCtrl"},"/me":{templateUrl:"views/me.html",controller:"MeCtrl"}}).config(["$routeProvider","paths",function(a,b){angular.forEach(b,function(b,c){a.when(c,b)}),a.otherwise({redirectTo:"/login"})}]).run(["$rootScope","leancloud",function(a,b){AV.initialize("xv1cgfapsn90hyy2a42i9q6jg7phbfmdpt1404li6n93tt2r","70sp4h8prccxzyfp56vwm9ksczji36bsrjvtwzvrzegfza67"),b.angularizeAll()}]).factory("$exceptionHandler",["$window",function(a){return function(b){throw b.stack&&(b.stack=b.stack.replace("new ","")),a.atatus,b}}]),angular.module("betaApp").controller("MainCtrl",["$scope","$rootScope","$location","userService","dataService",function(a,b,c,d){a.checkLogin=function(){d.isLogin()||c.url("login")},d.updateCurrentUser().then(function(){console.log("user service ready")},function(){console.log("user service ready")}),a.init=function(){d.updateCurrentUser().then(function(){a.checkLogin()},function(){c.url("login")})},a.logout=function(){d.logout().then(function(){c.url("login")},function(a){console.log("err,%s",a),c.url("login")})}}]),angular.module("betaApp").controller("AboutCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("betaApp").controller("WatchedCtrl",["$scope","$rootScope","$location","userService","dataService",function(a,b,c,d){a.init=function(){d.ready.then(function(){return d.isLogin()?void(a.watchedProducts=b.currentUser.watched):void c.url("login")},function(a){console.error(a)})}}]),angular.module("betaApp").controller("RankCtrl",["$scope","dataService",function(a,b){b.getRankProducts().then(function(b){a.ranks=b},function(a){console.error(a)})}]),angular.module("betaApp").controller("SearchCtrl",["$scope","$routeParams","dataService",function(a,b,c){a.search=function(){c.searchProduct(a.query).then(function(b){console.log("result,%s",JSON.stringify(b)),a.results=b})},a.init=function(){a.query={},b.name&&(a.query.name=b.name,a.search())}}]),angular.module("betaApp").controller("LoginCtrl",["$scope","$rootScope","$location","userService",function(a,b,c,d){a.login=function(){d.login("fxp007","1234").then(function(){c.url("watched")},function(){console.log("err")})}}]),angular.module("betaApp").service("dataService",["$rootScope","$q","productCaches","leancloud",function(a,b,c,d){function e(a){return b(function(b,c){new AV.Query("_User").get(a).then(function(a){b(a)},function(a){c(a)})})}function f(a){return b(function(b,d){a.relation("followedProducts").query().find().then(function(a){angular.forEach(a,function(a){c.product.put(a.id,a)}),b(a)},function(a){d(a)})})}function g(a){return b(function(b,c){d.objectQuery("Product").get(a).then(function(a){b(a)},function(a){c(a)})},0)}function h(a){return b(function(b,e){var f={};d.objectQuery("Product").get(a).then(function(a){f.product=a;var b=d.objectQuery("ProductDetail");return b.equalTo("product",a),b.first()}).then(function(a){f.detail=a,c.productExt.put(f.product.id,f),b(f)},function(a){e(a)})},0)}function i(a){return b(function(b,c){d.reverseQuery("News","relatedProducts",a).find().then(function(a){b(a)},function(a){c(a)})})}function j(a){return b(function(b,e){var f=d.objectQuery("Product");angular.forEach(a,function(a,b){f.contains(b,a)}),f.find().then(function(a){angular.forEach(a,function(a){c.product.put(a.id,a)}),b(a)},function(a){e(a)})},0)}function k(a,c){return b(function(b,e){var f=d.objectQuery("News");f.limit(a),f.skip(c),f.find().then(function(a){b(a)},function(a){e(a)})})}function l(a,c){return b(function(b,e){d.relationQuery(a,c).find().then(function(a){b(a)},function(a){e(a)})})}function m(a){return b(function(b,c){f(a).then(function(c){a.watched=c,b(a)},function(a){c(a)})})}function n(a){return b(function(b,c){d.saveObject(a).then(function(a){return m(a)}).then(function(){b(a)},function(a){c(a)})})}function o(a,c){return b(function(b,e){var f=d.objectQuery("ChartWeekly");f.equalTo("product",a),f.equalTo("type",c),f.first().then(function(a){b(a)},function(a){e(a)})})}function p(){return b(function(a,b){var c=d.objectQuery("DailyRank");c.limit(10),c.descending("normalisedRank"),c.include("product"),c.find().then(function(b){a(b)},function(a){b(a)})})}function q(){return b(function(a,b){d.getStatuses().then(function(b){a(b)},function(a){b(a)})})}return{getProduct:g,getWatchedProducts:f,getExtendedProduct:h,userInfo:e,searchProduct:j,getNewsByProduct:i,getLatestNews:k,getRelationField:l,getExtendedUser:m,saveAndUpdateUser:n,getLatestChartData:o,getRankProducts:p,getStatusList:q}}]),angular.module("betaApp").service("userService",["$q","$rootScope","dataService",function(a,b,c){function d(){return!(_.isNull(b.currentUser)||_.isUndefined(b.currentUser))}function e(b,c){var d=a.defer();return AV.User.logIn(b,c).then(function(){return g()}).then(function(a){d.resolve(a)},function(a){d.reject(a)}),d.promise}function f(){var c=a.defer();return AV.User.logOut(),b.currentUser=void 0,c.resolve(),c.promise}function g(){return a(function(a,d){AV.User.current()?c.userInfo(AV.User.current().id).then(function(a){return c.getExtendedUser(a)}).then(function(c){b.currentUser=c,i.resolve(),a(c)},function(a){i.reject(),d(a)}):(b.currentUser=void 0,i.reject(),d("not log in"))})}function h(d,e){return a(function(a,f){var g=b.currentUser.relation("followedProducts");d?g.add(e):g.remove(e),c.saveAndUpdateUser(b.currentUser).then(function(b){a(b)},function(a){f(a)})})}var i=a.defer();return{isLogin:d,login:e,logout:f,updateCurrentUser:g,watchProduct:h,ready:i.promise}}]),angular.module("betaApp").service("leancloud",function(){function a(){angular.forEach(j,function(a,b){var c=AV.Object.extend(b);angular.forEach(a.attributes,function(a){Object.defineProperty(c.prototype,a,{get:function(){return this.get(a)},set:function(b){this.set(a,b)}})})})}function b(a){return i[a]||AV.Object.extend(a)}function c(a){return new AV.Query(b(a))}function d(a,c){var d=b(a);return new d(c)}function e(a,b,c){return AV.Relation.reverseQuery(a,b,c)}function f(a,b){return a.relation(b).query()}function g(a){return a.save()}function h(){return AV.Status.inboxQuery(AV.User.current(),"private").find()}var i={},j={News:{attributes:["title","link","source"]},Product:{attributes:["name","website"]},ProductDetail:{attributes:["size","price","description","developer","source","category"]},ChartWeekly:{attributes:["data"]},DailyRank:{attributes:["normalisedRank","source","rankValue","product"]},_User:{attributes:["username"]},_Status:{attributes:["data"]}};return{angularizeAll:a,objectRef:b,objectQuery:c,newInstance:d,reverseQuery:e,relationQuery:f,saveObject:g,getStatuses:h}}),angular.module("betaApp").factory("productCaches",["$cacheFactory",function(a){return{product:a("product"),productExt:a("product-ext")}}]),angular.module("betaApp").constant("chartNames",[{type:"rateValue",alias:"评分"},{type:"rateCount",alias:"评分次数"},{type:"commentCount",alias:"评论次数"}]).controller("ProductCtrl",["$scope","$rootScope","$routeParams","$location","productCaches","dataService","userService","chartNames",function(a,b,c,d,e,f,g,h){function i(){var c=!1;angular.forEach(b.currentUser.watched,function(b){a.pid===b.id&&(c=!0)}),a.watched=c}function j(){return a.product=e.product.get(a.pid),f.getExtendedProduct(a.pid).then(function(b){return a.product=b.product,a.detail=b.detail,f.getNewsByProduct(a.product)}).then(function(b){a.newss=b,angular.forEach(a.charts,function(a){k(a)}),a.loaded=!0})}function k(b){var c={labels:[],datasets:[{fillColor:"rgba(151,187,205,0.2)",strokeColor:"rgba(151,187,205,1)",pointColor:"rgba(151,187,205,1)",pointStrokeColor:"#fff",pointHighlightFill:"#fff",pointHighlightStroke:"rgba(151,187,205,1)",data:[]}]};f.getLatestChartData(a.product,b.type).then(function(a){console.log("chart,%s,%s,%s",b.type,b.name,JSON.stringify(a)),a&&(b.show=!1,angular.forEach(a.data,function(a,b){c.labels.push(b),c.datasets[0].data.push(a)}),b.ctx=b.ctx||angular.element.find("#"+b.domId)[0].getContext("2d"),b.chartObj=b.chartObj||new Chart(b.ctx).Line(c),b.chartObj.update(),_.size(a.data)>1&&(b.show=!0))},function(a){console.error(a)})}a.loaded=!1,a.debug=!1,a.pid=c.pid,a.charts=[],a.init=function(){function b(b){var c={name:b.alias,type:b.type,domId:"chart_"+a.pid+"_"+b.type,show:!1};a.charts.push(c)}a.pid?(g.ready.then(function(){i(a.pid),j()},function(){j()}),angular.forEach(h,function(a){b(a)})):d.url("watched")},a.watch=function(b){g.watchProduct(b,a.product).then(function(){i()},function(a){console.error(a)})},a.calculate=function(){}}]),angular.module("betaApp").controller("NewsCtrl",["$scope","$routeParams","$location","dataService",function(a,b,c,d){a.init=function(){return a.limit=b.limit?parseInt(b.limit):void 0,a.skip=b.skip?parseInt(b.skip):void 0,angular.isUndefined(a.limit)||a.limit<=0||angular.isUndefined(a.skip)||a.skip<0?void c.url("news/0/10"):void d.getLatestNews(a.limit,a.skip).then(function(b){a.newss=b,angular.forEach(b,function(a){d.getRelationField(a,"relatedProducts").then(function(b){a.related=b,a.loaded=!0},function(a){console.error(a)})})},function(a){console.error(a)})}}]),angular.module("betaApp").controller("MeCtrl",["$scope","dataService",function(a,b){a.init=function(){b.getStatusList().then(function(b){a.statusList=b},function(a){console.error(a)})}}]);